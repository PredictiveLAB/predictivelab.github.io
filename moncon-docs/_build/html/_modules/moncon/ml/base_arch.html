<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>moncon.ml.base_arch &mdash; PredictiveLab 0.9.38 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> PredictiveLab
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PredictiveLab</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>moncon.ml.base_arch</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for moncon.ml.base_arch</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Defines the base classes for all ML models.</span>

<span class="sd">Classes defined:</span>
<span class="sd">    - BaseArch: Base class for all ML architectures</span>
<span class="sd">        - SklearnSupervisedModel: Base class for all supervised ML Sklearn models</span>
<span class="sd">        - DLSupervisedModel (BaseArch): Base class for all supervised Deep Learning models</span>
<span class="sd">        - BaseAnomalyModel (BaseArch): Base class for all anomaly (or novelty) detection models</span>
<span class="sd">            - AutoEncoderModel (BaseAnomalyModel): Base class for all AutoEncoder models</span>
<span class="sd">            - SklearnAnomalyModel (BaseAnomalyModel): Base class for all sklearn anomaly models</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">RandomizedSearchCV</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">accuracy_score</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">uniform</span><span class="p">,</span> <span class="n">randint</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>

<span class="kn">from</span> <span class="nn">moncon.errors</span> <span class="kn">import</span> <span class="n">Errors</span>
<span class="kn">from</span> <span class="nn">moncon.tools</span> <span class="kn">import</span> <span class="n">preprocessing_ops</span>


<div class="viewcode-block" id="BaseArch"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.BaseArch">[docs]</a><span class="k">class</span> <span class="nc">BaseArch</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Basic architecture and methods for all ML architectures, which are mainly composed of</span>
<span class="sd">    the following functionalities:</span>
<span class="sd">        - preprocessing input data</span>
<span class="sd">        - model training and prediction</span>
<span class="sd">        - save and load learned parameters and models</span>

<span class="sd">    Classes that inherit from this class are:</span>
<span class="sd">        - SklearnSupervisedModel</span>
<span class="sd">        - DLSupervisedModel</span>
<span class="sd">        - BaseAnomalyModel</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arch_params</span><span class="p">,</span> <span class="n">chckpt_filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arch_params</span> <span class="o">=</span> <span class="n">arch_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chckpt_filepath</span> <span class="o">=</span> <span class="n">chckpt_filepath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s2">&quot;preprocess_method&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">arch_params</span><span class="p">:</span>
            <span class="n">arch_params</span><span class="p">[</span><span class="s2">&quot;preprocess_method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="BaseArch.aggregate"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.BaseArch.aggregate">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">aggregate</span><span class="p">(</span><span class="n">predictions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">aggregation</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Aggregate predictions with the selected method.</span>
<span class="sd">        Currently, &#39;MEAN&#39;, &#39;MAX, &#39;MIN&#39; and &#39;SUM&#39; are supported.</span>
<span class="sd">        If a different method is selected, None is returned.</span>

<span class="sd">        Args:</span>
<span class="sd">            predictions (np.ndarray): ML model predictions</span>
<span class="sd">            aggregation (str): aggregation method</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: aggregated predictions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;MEAN&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">predictions</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;MAX&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">predictions</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;MIN&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">predictions</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="s2">&quot;SUM&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">predictions</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="BaseArch.apply_cols_mask"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.BaseArch.apply_cols_mask">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">apply_cols_mask</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">cols_mask</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">columns_to_drop</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cols_mask</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">v</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">columns</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">dataset</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columns_to_drop</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseArch.clean_dataset"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.BaseArch.clean_dataset">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">clean_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">cols_mask</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Clean dataset by standardizing column names and removing columns according to cols_mask.</span>
<span class="sd">        Also, separates timestamp column from the rest of the dataset, and returns them separately;</span>
<span class="sd">        if no timestamp column is found, None is returned for the timestamp column.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (pd.DataFrame): Dataframe with dataset to clean</span>
<span class="sd">            cols_mask (Dict[str, bool], optional): Dict with columns names as key and bool as value.</span>
<span class="sd">                determines if each column should be dropped. if cols_mask is None, all are kept.</span>
<span class="sd">                Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[pd.Series, pd.DataFrame]: Tuple with timestamp column and cleaned dataset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="k">lambda</span> <span class="n">name</span><span class="p">:</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cols_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">BaseArch</span><span class="o">.</span><span class="n">apply_cols_mask</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">cols_mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;timestamp&quot;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">dataset</span></div>

    <span class="c1"># ? This function is very similar to clean_dataset, might be a good idea to merge them</span>
<div class="viewcode-block" id="BaseArch.parse_dataset"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.BaseArch.parse_dataset">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parse_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">cols_mask</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parse dataset by standardizing column names and removing columns according to cols_mask,</span>
<span class="sd">        also removes timestamp and target columns. Returns the rest of the dataset as a numpy array.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (pd.DataFrame): Dataframe with dataset to clean</span>
<span class="sd">            cols_mask (Dict[str, bool]): Dictionary with columns names as key and bool as value.</span>
<span class="sd">                determines if each column should be dropped. if cols_mask is None, all are kept.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: parsed dataset as numpy array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="k">lambda</span> <span class="n">name</span><span class="p">:</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cols_mask</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">cols_mask</span><span class="p">}</span>
        <span class="k">if</span> <span class="s2">&quot;target&quot;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">cols_mask</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">cols_mask</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">BaseArch</span><span class="o">.</span><span class="n">apply_cols_mask</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">cols_mask</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span></div>

<div class="viewcode-block" id="BaseArch.init_preprocess"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.BaseArch.init_preprocess">[docs]</a>    <span class="k">def</span> <span class="nf">init_preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize preprocessing method by loading it from a checkpoint file, or by</span>
<span class="sd">        creating a new one with the parameters specified in arch_params[&quot;preprocess_method&quot;].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arch_params</span><span class="p">[</span><span class="s2">&quot;preprocess_method&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">prep_hps</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arch_params</span><span class="p">[</span><span class="s2">&quot;preprocess_method&quot;</span><span class="p">]):</span>
                <span class="n">preprocess_filepath</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chckpt_filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">preprocess_filepath</span> <span class="o">=</span> <span class="n">preprocessing_ops</span><span class="o">.</span><span class="n">get_prerprocess_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chckpt_filepath</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">preprocessing_ops</span><span class="o">.</span><span class="n">init_preprocess</span><span class="p">(</span><span class="n">prep_hps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">prep_hps</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">preprocess_filepath</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">n_components</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">arch_params</span><span class="p">[</span><span class="s2">&quot;feature_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">n_components</span></div>

<div class="viewcode-block" id="BaseArch.preprocess_from_dataset"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.BaseArch.preprocess_from_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">preprocess_from_dataset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">cols_mask</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">],</span>
        <span class="n">out_chckpt_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">log_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">phase</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">split_periods</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Preprocess input dataset by calling clean_dataset method, then extracting x and y from</span>
<span class="sd">        the dataset using the &#39;target&#39; column (if phase == &#39;test&#39;, then it is assumed that &#39;target&#39;</span>
<span class="sd">        column is not in the dataset, and y set to None), then calling preprocess method on x and y.</span>
<span class="sd">        Returns the timestamps together with the preprocessed x and y.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (pd.DataFrame): Dataset to preprocess</span>
<span class="sd">            cols_mask (Dict[str, bool]): Dictionary with columns names as key and bool as value.</span>
<span class="sd">                determines if each column should be dropped. if cols_mask is None, all are kept.</span>
<span class="sd">            out_chckpt_filepath (str): Path to file where preprocess method params will be saved</span>
<span class="sd">            log_filepath (str): Path to the log file used to log preprocessing progress</span>
<span class="sd">            phase (str): Phase of the preprocessing, either &#39;train&#39; or &#39;test&#39;</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[pd.Series, np.ndarray, np.ndarray]: Tuple with timestamps and preprocessed x and y</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># clean data</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">BaseArch</span><span class="o">.</span><span class="n">clean_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">cols_mask</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">:</span>
            <span class="c1"># split into input (x) and output (y) variables</span>
            <span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">dataset</span><span class="p">[(</span><span class="n">dataset</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;from&quot;</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">]))]</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">split_periods</span>
                    <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;split&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">y_train</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span>
            <span class="n">X_train</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">])</span>

            <span class="n">valid</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">dataset</span><span class="p">[(</span><span class="n">dataset</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;from&quot;</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">]))]</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">split_periods</span>
                    <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;split&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;valid&quot;</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">y_valid</span> <span class="o">=</span> <span class="n">valid</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span>
            <span class="n">X_valid</span> <span class="o">=</span> <span class="n">valid</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">dataset</span>
            <span class="n">y</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># train preprocess method and preprocess data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arch_params</span><span class="p">[</span><span class="s2">&quot;preprocess_method&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># open logging file</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;wt&quot;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">txt_log</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">prep</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">:</span>
                        <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">preprocessing_ops</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
                            <span class="n">prep</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">out_chckpt_filepath</span><span class="p">,</span> <span class="n">txt_log</span>
                        <span class="p">)</span>
                        <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span> <span class="o">=</span> <span class="n">preprocessing_ops</span><span class="o">.</span><span class="n">valid_transform</span><span class="p">(</span><span class="n">prep</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">,</span> <span class="n">txt_log</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">X</span> <span class="o">=</span> <span class="n">preprocessing_ops</span><span class="o">.</span><span class="n">test_transform</span><span class="p">(</span><span class="n">prep</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">txt_log</span><span class="p">)</span>

                <span class="c1"># update the &#39;in_size&#39; hiperparameter accorrding to the preprocessing output</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">n_components</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">arch_params</span><span class="p">[</span><span class="s2">&quot;feature_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">n_components</span>

        <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span>
        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span></div>

<div class="viewcode-block" id="BaseArch.preprocess_from_csv"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.BaseArch.preprocess_from_csv">[docs]</a>    <span class="k">def</span> <span class="nf">preprocess_from_csv</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset_csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">cols_mask</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">],</span>
        <span class="n">out_chckpt_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">log_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">phase</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">split_periods</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Loads dataset from csv file, then calls preprocess_from_dataset method.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset_csv_path (str): Path to the csv file with dataset</span>
<span class="sd">            cols_mask (Dict[str, bool]): Dictionary with columns names as key and bool as value.</span>
<span class="sd">                determines if each column should be dropped. if cols_mask is None, all are kept.</span>
<span class="sd">            out_chckpt_filepath (str): Path to file where preprocess method params will be saved</span>
<span class="sd">            log_filepath (str): Path to the log file used to log preprocessing progress</span>
<span class="sd">            phase (str): Phase of the preprocessing, either &#39;train&#39; or &#39;test&#39;</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[pd.Series, np.ndarray, np.ndarray]: Tuple with timestamps and preprocessed x and y</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dataset_csv_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_from_dataset</span><span class="p">(</span>
            <span class="n">dataset</span><span class="p">,</span> <span class="n">cols_mask</span><span class="p">,</span> <span class="n">out_chckpt_filepath</span><span class="p">,</span> <span class="n">log_filepath</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">split_periods</span>
        <span class="p">)</span></div>

    <span class="c1"># ? It may be better to use this method to initialize both model and preprocessing</span>
<div class="viewcode-block" id="BaseArch.init_arch"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.BaseArch.init_arch">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">init_arch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Abstract method for all ML architectures to initialize their internal ML model.</span>

<span class="sd">        Initialize model by loading it from a checkpoint file, or by</span>
<span class="sd">        creating a new one with the parameters specified in arch_params</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">Errors</span><span class="o">.</span><span class="n">INIT_ARCH_NOT_IMPLEMENTED</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseArch.fit"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.BaseArch.fit">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">y_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">X_valid</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">y_valid</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">train_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">out_chckpt_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">log_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">metrics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Abstract method for all ML architectures to fit their internal model.</span>

<span class="sd">        Args:</span>
<span class="sd">            X_train (np.ndarray): Input training data</span>
<span class="sd">            y_train (np.ndarray): Label training data</span>
<span class="sd">            X_valid (np.ndarray): Input validation data</span>
<span class="sd">            y_valid (np.ndarray): Label validation data</span>
<span class="sd">            train_params (Dict[str, Any]): Dictionary with parameters necessary for training</span>
<span class="sd">            out_chckpt_filepath (str): Path to the checkpoint file where the model will be saved</span>
<span class="sd">            log_filepath (str): Path to the log file used to log training progress</span>
<span class="sd">            metrics (List[str]): List of metrics to be used for training</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">Errors</span><span class="o">.</span><span class="n">FIT_NOT_IMPLEMENTED</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseArch.parse_fit_logging"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.BaseArch.parse_fit_logging">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">parse_fit_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">epochs</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">}</span>

        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;epoch: \d+, &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">: \d+\.\d+&quot;</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">]))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                    <span class="n">parse</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[-+]?\d*\.\d+|\d+&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                    <span class="n">epochs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">parse</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">):</span>
                        <span class="n">scores</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parse</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">epochs</span><span class="p">,</span> <span class="n">scores</span></div>

<div class="viewcode-block" id="BaseArch.predict"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.BaseArch.predict">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">timestamps</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
        <span class="n">aggregation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">log_filepath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Abstract method for all ML architectures use their internal model to predict on data.</span>
<span class="sd">        Returns the predicted values and the result of their aggregation (using &#39;aggregate&#39; method).</span>
<span class="sd">        Timestamps are only used while logging.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (np.ndarray): Input data</span>
<span class="sd">            timestamps (pd.Series): Timestamps of the input data</span>
<span class="sd">            aggregation (str): Aggregation method to be used for prediction</span>
<span class="sd">            log_filepath (str): Path to the log file used to log prediction progress</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[np.ndarray, np.ndarray]: Tuple with predicted values and aggregated values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">Errors</span><span class="o">.</span><span class="n">PREDICT_NOT_IMPLEMENTED</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseArch.parse_predict_logging"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.BaseArch.parse_predict_logging">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">parse_predict_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_filepath</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="BaseArch.split_windows"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.BaseArch.split_windows">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">split_windows</span><span class="p">(</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">window_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">overlap</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Preprocess timeseries data of size (time, n_features) by splitting</span>
<span class="sd">        it into windows (matrices), takes &#39;window_size&#39; parameter to define the size</span>
<span class="sd">        of the windows, and &#39;overlap&#39; parameter to define the overlap between windows.</span>
<span class="sd">        Returns an array of size (n_windows, &#39;window_size&#39;, n_features)</span>

<span class="sd">        Note: if the input data is not perfectly divisible by amount of windows,</span>
<span class="sd">        data at the beginning that is not included in the windows will be dropped.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (pd.DataFrame): Timeseries data</span>
<span class="sd">            y (pd.Series): Timeseries labels</span>
<span class="sd">            window_size (int): Size of the windows to be split into</span>
<span class="sd">            overlap (int): Overlap size to use when splitting the data set into windows</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[pd.DataFrame, pd.Series, np.ndarray]: Tuple containing arrays with windows,</span>
<span class="sd">                labels and timestamps</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">window_size</span> <span class="o">-</span> <span class="n">overlap</span>
        <span class="c1"># number of windows</span>
        <span class="n">n_windows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">overlap</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">step</span><span class="p">))</span>
        <span class="c1"># starting index</span>
        <span class="n">first_idx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">n_windows</span> <span class="o">*</span> <span class="p">(</span><span class="n">step</span><span class="p">)</span> <span class="o">+</span> <span class="n">overlap</span><span class="p">)</span>

        <span class="c1"># create arrays for windows and labels</span>
        <span class="n">X_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_windows</span><span class="p">,</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">index_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_windows</span><span class="p">,))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_windows</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">step</span> <span class="o">+</span> <span class="n">first_idx</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">window_size</span>
            <span class="n">X_out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
            <span class="n">index_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">y_out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y_out</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index_out</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">X_out</span><span class="p">,</span> <span class="n">y_out</span><span class="p">,</span> <span class="n">index_out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">X_out</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">index_out</span></div></div>


<div class="viewcode-block" id="SklearnSupervisedModel"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.SklearnSupervisedModel">[docs]</a><span class="k">class</span> <span class="nc">SklearnSupervisedModel</span><span class="p">(</span><span class="n">BaseArch</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for all Sklearn supervised models.</span>
<span class="sd">    Inherits from BaseAnomalyModel. Classes that inherit from this class are:</span>
<span class="sd">        - RandomForestCls</span>
<span class="sd">        - XGBoostCls</span>

<span class="sd">    Defines the methods that are common to all Sklearn supervised architectures, which are:</span>
<span class="sd">        - load_model</span>
<span class="sd">        - save_model</span>
<span class="sd">        - fit</span>
<span class="sd">        - predict</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arch_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chckpt_filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SklearnSupervisedModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">arch_params</span><span class="p">,</span> <span class="n">chckpt_filepath</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;scores&quot;</span> <span class="ow">in</span> <span class="n">arch_params</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="n">arch_params</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;confusion_matrix&quot;</span><span class="p">,</span> <span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;f1-score&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="SklearnSupervisedModel.load_model"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.SklearnSupervisedModel.load_model">[docs]</a>    <span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loads the sklearn model from the checkpoint file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chckpt_filepath</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arch_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_params</span><span class="p">())</span></div>

<div class="viewcode-block" id="SklearnSupervisedModel.save_model"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.SklearnSupervisedModel.save_model">[docs]</a>    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_chckpt_filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Saves the sklearn model on the defined checkpoint file.</span>

<span class="sd">        Args:</span>
<span class="sd">            out_chckpt_filepath (str): Path to the checkpoint file where the model will be saved</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_chckpt_filepath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>

<div class="viewcode-block" id="SklearnSupervisedModel.fit"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.SklearnSupervisedModel.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">y_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
        <span class="n">X_valid</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">y_valid</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
        <span class="n">train_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">out_chckpt_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">log_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">metrics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit method for Sklearn Supervised models.</span>
<span class="sd">        Fits the internal model with the given data, and saves the model on the defined file.</span>

<span class="sd">        Args:</span>
<span class="sd">            X_train (pd.DataFrame): Input training data</span>
<span class="sd">            y_train (pd.Series): Label training data</span>
<span class="sd">            X_valid (pd.DataFrame): Input validation data</span>
<span class="sd">            y_valid (pd.Series): Label validation data</span>
<span class="sd">            train_params (Dict[str, Any]): Ignored for Sklearn Supervised models.</span>
<span class="sd">            out_chckpt_filepath (str): Path to the checkpoint file where the model will be saved</span>
<span class="sd">            log_filepath (str): Path to the log file used to log training progress</span>
<span class="sd">            metrics (List[str]): List of metrics to be used for training</span>

<span class="sd">        *Note: Right now the metrics and log_filepath are not used for training.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Train the model</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Training the Sklearn model on train split...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="c1"># Validate the model</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Predicting on validation split...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span>

        <span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s2">&quot;confusion_matrix&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">:</span>
            <span class="c1"># create confusion matrix</span>
            <span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">prediction</span><span class="p">)</span>
            <span class="n">scores</span><span class="p">[</span><span class="s2">&quot;confusion_matrix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cm</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;confusion_matrix:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">cm</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;accuracy&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">:</span>
            <span class="c1"># Display accuracy score</span>
            <span class="n">acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">prediction</span><span class="p">)</span>
            <span class="n">scores</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">acc</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;accuracy: </span><span class="si">{</span><span class="n">acc</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;f1-score&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">:</span>
            <span class="c1"># Display F1 score</span>
            <span class="n">f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">prediction</span><span class="p">)</span>
            <span class="n">scores</span><span class="p">[</span><span class="s2">&quot;f1-score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f1</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;f1-score: </span><span class="si">{</span><span class="n">f1</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.scores.npz&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">scores</span><span class="p">)</span>

        <span class="c1"># Save the model</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Saving the Sklearn&#39;s model...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">out_chckpt_filepath</span><span class="p">)</span></div>

<div class="viewcode-block" id="SklearnSupervisedModel.predict"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.SklearnSupervisedModel.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">timestamps</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
        <span class="n">aggregation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">log_filepath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Predict method for Sklearn Supervised models.</span>
<span class="sd">        Uses the internal model&#39;s predict to get a predicted class.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (pd.DataFrame): Input data</span>
<span class="sd">            timestamps (pd.Series): Timestamps for the input data. Deprecated, not used.</span>
<span class="sd">            aggregation (str): Aggregation method to be used for prediction</span>
<span class="sd">            log_filepath (str): Path to the log file used to log progress</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[np.ndarray, np.ndarray]: Tuple with predicted label and aggregated values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># make probability predictions with the model</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">aggregated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">aggregation</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">log_filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_index</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;all predictions:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">x_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_index</span><span class="p">,</span> <span class="n">predictions</span><span class="p">):</span>
                        <span class="n">t_str</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\t</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;aggregated prediction: </span><span class="si">{</span><span class="n">aggregated</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">aggregated</span></div>

    <span class="c1"># TODO: Fix this method, it is not used</span>
<div class="viewcode-block" id="SklearnSupervisedModel.random_search_opt"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.SklearnSupervisedModel.random_search_opt">[docs]</a>    <span class="k">def</span> <span class="nf">random_search_opt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data_csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">random_search_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scoring</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;accuracy&quot;</span><span class="p">,</span>
        <span class="n">search_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Random search method for Sklearn Supervised models.</span>
<span class="sd">        Currently loads the data from the given csv file, loads standard parameters if not given,</span>
<span class="sd">        and performs a random searchCV for the given parameters.</span>

<span class="sd">        Note: As it uses CV, it may not make sense to use this method for time series data.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_csv_path (str): Path to the csv file containing the data to be used for training</span>
<span class="sd">            grid_search_params (Dict[str, Any]): Parameters to be used for the random search</span>
<span class="sd">            scoring (str): Scoring method to be used for the random search</span>
<span class="sd">            grid_params (Dict[str, Any]): Parameters to be used for the random search</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># load the dataset</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_csv_path</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

        <span class="c1"># split into input (X) and output (y) variables</span>
        <span class="n">x_train</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="n">default_search_params</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;anomaly_detection&quot;</span><span class="p">,</span> <span class="s2">&quot;anomaly_params.json&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">random_search_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">random_search_params</span> <span class="o">=</span> <span class="n">default_search_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">)</span>

            <span class="c1"># reformat values</span>
            <span class="n">random_search_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reformat_random_params_dic</span><span class="p">(</span><span class="n">random_search_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">search_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">search_params</span> <span class="o">=</span> <span class="n">default_search_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;grid_params&quot;</span><span class="p">)</span>

        <span class="n">random_s</span> <span class="o">=</span> <span class="n">RandomizedSearchCV</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">param_distributions</span><span class="o">=</span><span class="n">random_search_params</span><span class="p">,</span>
            <span class="n">scoring</span><span class="o">=</span><span class="n">scoring</span><span class="p">,</span>
            <span class="o">**</span><span class="n">search_params</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">random_s</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">df_params</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">random_s</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">)</span>
        <span class="n">id_max</span> <span class="o">=</span> <span class="n">df_params</span><span class="p">[</span><span class="s2">&quot;mean_test_score&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
        <span class="n">best_params</span> <span class="o">=</span> <span class="n">df_params</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">id_max</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arch_params</span> <span class="o">=</span> <span class="n">best_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arch_params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_csv_path</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_reformat_random_params_dic</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reformats the given parameters dictionary to be used by the random search.</span>
<span class="sd">        Changes *_low and *_high params for a distribution</span>

<span class="sd">        Args:</span>
<span class="sd">            params (dict): Parameters to be used for the random search</span>
<span class="sd">            model_name (str): Name of the model to be used</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Reformatted parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params_to_change</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;LocalOutlierFactor&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;n_neighbors&quot;</span><span class="p">,</span> <span class="n">randint</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;contamination&quot;</span><span class="p">,</span> <span class="n">uniform</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;OneClassSVM&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;nu&quot;</span><span class="p">,</span> <span class="n">uniform</span><span class="p">)],</span>
            <span class="s2">&quot;IsolationForest&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;n_estimators&quot;</span><span class="p">,</span> <span class="n">randint</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;contamination&quot;</span><span class="p">,</span> <span class="n">uniform</span><span class="p">)],</span>
            <span class="s2">&quot;EllipticEnvelope&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;support_fraction&quot;</span><span class="p">,</span> <span class="n">uniform</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;contamination&quot;</span><span class="p">,</span> <span class="n">uniform</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

        <span class="n">to_change</span> <span class="o">=</span> <span class="n">params_to_change</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">to_change</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">param_name</span> <span class="o">+</span> <span class="s2">&quot;_low&quot;</span><span class="p">),</span> <span class="n">params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">param_name</span> <span class="o">+</span> <span class="s2">&quot;_high&quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">params</span>

<div class="viewcode-block" id="SklearnSupervisedModel.parse_fit_logging"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.SklearnSupervisedModel.parse_fit_logging">[docs]</a>    <span class="k">def</span> <span class="nf">parse_fit_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_filepath</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.scores.npz&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">}</span></div>

<div class="viewcode-block" id="SklearnSupervisedModel.parse_predict_logging"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.SklearnSupervisedModel.parse_predict_logging">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parse_predict_logging</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">):</span>
        <span class="n">timestamps</span><span class="p">,</span> <span class="n">all_probs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;\d</span><span class="si">{4}</span><span class="s2">-\d?\d-\d?\d (?:2[0-3]|[01]?[0-9]):[0-5]?[0-9]:[0-5]?[0-9]:</span><span class="se">\t</span><span class="s2">\[.+\]&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                    <span class="n">parse</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parse</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">all_probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">parse</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">timestamps</span><span class="p">,</span> <span class="n">all_probs</span></div></div>


<div class="viewcode-block" id="DLSupervisedModel"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.DLSupervisedModel">[docs]</a><span class="k">class</span> <span class="nc">DLSupervisedModel</span><span class="p">(</span><span class="n">BaseArch</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for all supervised Deep Learning architectures.</span>
<span class="sd">    Inherits from BaseArch. Classes  that inherit from this class are:</span>
<span class="sd">        - MLP</span>
<span class="sd">        - CNN</span>
<span class="sd">        - RNN</span>

<span class="sd">    Defines the methods that are common to all supervised ML architectures, which are:</span>
<span class="sd">        - fit</span>
<span class="sd">        - predict</span>

<span class="sd">    Introduces the following necessary values in train_params:</span>
<span class="sd">        - train_params[&quot;batch_size&quot;] (int): Batch size for training</span>
<span class="sd">        - train_params[&quot;epochs&quot;] (int): Number of epochs for training</span>

<span class="sd">    Introduces the following instance attributes to be filled by the child classes:</span>
<span class="sd">        - self.use_split_windows (bool): Whether to use the method split windows or not,</span>
<span class="sd">            used to split the data set into an array of windows (matrices) before entering</span>
<span class="sd">            the model; used by the child classes CNN and RNN</span>
<span class="sd">        - self.windows_size (int): Size of the windows to be split into</span>
<span class="sd">            (only used if use_split_windows is True)</span>
<span class="sd">        - self.overlap (int): Overlap size to use when splitting the data set into windows</span>
<span class="sd">            (only used if use_split_windows is True)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arch_params</span><span class="p">,</span> <span class="n">chckpt_filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">arch_params</span><span class="p">,</span> <span class="n">chckpt_filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_split_windows</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="n">arch_params</span><span class="p">[</span><span class="s2">&quot;metric&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">,</span> <span class="s2">&quot;val_loss&quot;</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;val_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>

    <span class="c1"># TODO: add use of metrics parameter</span>
<div class="viewcode-block" id="DLSupervisedModel.fit"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.DLSupervisedModel.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">y_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
        <span class="n">X_valid</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">y_valid</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
        <span class="n">train_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">out_chckpt_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">log_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">metrics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit method for supervised Deep Learning architectures.</span>
<span class="sd">        Fits the internal model with the given data and parameters,</span>
<span class="sd">        and saves the model to the given checkpoint file.</span>

<span class="sd">        train_params must contain the following values:</span>
<span class="sd">            - train_params[&quot;batch_size&quot;] (int): Batch size for training</span>
<span class="sd">            - train_params[&quot;epochs&quot;] (int): Number of epochs for training</span>

<span class="sd">        Args:</span>
<span class="sd">            X_train (pd.DataFrame): Training data</span>
<span class="sd">            y_train (pd.Series): Training labels</span>
<span class="sd">            X_valid (pd.DataFrame): Validation data</span>
<span class="sd">            y_valid (pd.Series): Validation labels</span>
<span class="sd">            train_params (Dict[str, Any]): Dictionary with parameters necessary for training</span>
<span class="sd">            out_chckpt_filepath (str): Path to the checkpoint file where the model will be saved</span>
<span class="sd">            log_filepath (str): Path to the log file used to log training progress</span>
<span class="sd">            metrics (List[str]): List of metrics to be used for training</span>

<span class="sd">        *Note: Right now the metrics are not used for training.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">train_params</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span>
        <span class="n">epochs</span> <span class="o">=</span> <span class="n">train_params</span><span class="p">[</span><span class="s2">&quot;epochs&quot;</span><span class="p">]</span>

        <span class="c1"># split the data into windows</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_split_windows</span><span class="p">:</span>
            <span class="n">X_train_array</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">train_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_windows</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span>
            <span class="n">X_valid_array</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">,</span> <span class="n">val_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_windows</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X_train_array</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">values</span>
            <span class="n">X_valid_array</span> <span class="o">=</span> <span class="n">X_valid</span><span class="o">.</span><span class="n">values</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">X_train_array</span><span class="p">,</span>
            <span class="n">y_train</span><span class="p">,</span>
            <span class="n">epochs</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="p">,</span>
            <span class="n">out_chckpt_filepath</span><span class="p">,</span>
            <span class="n">log_filepath</span><span class="p">,</span>
            <span class="n">x_val</span><span class="o">=</span><span class="n">X_valid_array</span><span class="p">,</span>
            <span class="n">y_val</span><span class="o">=</span><span class="n">y_valid</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="DLSupervisedModel.predict"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.DLSupervisedModel.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">timestamps</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
        <span class="n">aggregation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">log_filepath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Predict method for supervised Deep Learning architectures.</span>
<span class="sd">        Uses the internal model to predict on the given data and aggregates the results.</span>
<span class="sd">        Timestamps are only used while logging.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (pd.DataFrame): Input data</span>
<span class="sd">            timestamps (pd.Series): Timestamps of the input data. Deprecated.</span>
<span class="sd">            aggregation (str): Aggregation method to be used for prediction</span>
<span class="sd">            log_filepath (str): Path to the log file used to log prediction progress</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[np.ndarray, np.ndarray]: Tuple with predicted values and aggregated values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># split the data into windows</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_split_windows</span><span class="p">:</span>
            <span class="n">x_array</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">x_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_windows</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_index</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span>
            <span class="n">x_array</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># make predictions with the model</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_array</span><span class="p">,</span> <span class="n">log_filepath</span><span class="p">)</span>

        <span class="n">aggregated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">aggregation</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">log_filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;all predictions:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">x_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_index</span><span class="p">,</span> <span class="n">predictions</span><span class="p">):</span>
                        <span class="n">t_str</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\t</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;aggregated prediction: </span><span class="si">{</span><span class="n">aggregated</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">aggregated</span></div>

<div class="viewcode-block" id="DLSupervisedModel.parse_fit_logging"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.DLSupervisedModel.parse_fit_logging">[docs]</a>    <span class="k">def</span> <span class="nf">parse_fit_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_filepath</span><span class="p">):</span>
        <span class="n">epochs</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">}</span>

        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;epoch: \d+, &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">: \d+\.\d+&quot;</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">]))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                    <span class="n">parse</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[-+]?\d*\.\d+|\d+&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                    <span class="n">epochs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">parse</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">):</span>
                        <span class="n">scores</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parse</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">epochs</span><span class="p">,</span> <span class="n">scores</span></div>

<div class="viewcode-block" id="DLSupervisedModel.parse_predict_logging"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.DLSupervisedModel.parse_predict_logging">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parse_predict_logging</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">):</span>
        <span class="n">timestamps</span><span class="p">,</span> <span class="n">all_probs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;\d</span><span class="si">{4}</span><span class="s2">-\d?\d-\d?\d (?:2[0-3]|[01]?[0-9]):[0-5]?[0-9]:[0-5]?[0-9]:</span><span class="se">\t</span><span class="s2">\[.+\]&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                    <span class="n">parse</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parse</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">all_probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">parse</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">timestamps</span><span class="p">,</span> <span class="n">all_probs</span></div></div>


<div class="viewcode-block" id="BaseAnomalyModel"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.BaseAnomalyModel">[docs]</a><span class="k">class</span> <span class="nc">BaseAnomalyModel</span><span class="p">(</span><span class="n">BaseArch</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for all anomaly detection (or novelty detection) ML architectures.</span>
<span class="sd">    Inherits from BaseArch. Classes that inherit from this class are:</span>
<span class="sd">        - AutoEncoderModel</span>
<span class="sd">        - SklearnAnomalyModel</span>

<span class="sd">    Anomaly detection models output a KPI from 0 to 1 similar to a</span>
<span class="sd">    probability of a sample being an anomaly, this is determined by a</span>
<span class="sd">    sigmoid function after a linear transformation of the decision_function</span>
<span class="sd">    (distance metric) of the anomaly model.   1/(1 + exp(-(a * dist + b)))</span>

<span class="sd">    Currently, the KPI is set to be KPI_DIST_0 or more for anomalies, which can be</span>
<span class="sd">    used to calculate the &quot;b&quot; constant for the lineal transformation.</span>

<span class="sd">    Defines the methods that are common to all anomaly detection ML architectures, which are:</span>
<span class="sd">        - output_kpi</span>
<span class="sd">        - set_save_min_max_train_dist</span>
<span class="sd">        - scale_distance</span>
<span class="sd">        - save_scale_params</span>
<span class="sd">        - load_scale_params</span>

<span class="sd">    Introduces the following necessary values in arch_params:</span>
<span class="sd">        - arch_params[&quot;slope_coef&quot;]: Slope (or scale) factor for KPI calculation,</span>
<span class="sd">            defines how quickly the KPI grows</span>

<span class="sd">    Introduces the following class constants:</span>
<span class="sd">        - KPI_DIST_0 (float): Maximum KPI for a training sample to be considered as normal</span>

<span class="sd">    Introduces the following instance attributes:</span>
<span class="sd">        - self.slope_coef (float): Slope (or scale) factor for KPI calculation</span>
<span class="sd">        - self.max_train_dist (float): Maximum model&#39;s distance metric value for training data</span>
<span class="sd">        - self.min_train_dist (float): Minimum model&#39;s distance metric value for training data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># KPI set to be KPI_DIST_0 or more for anomalies</span>
    <span class="n">KPI_DIST_0</span> <span class="o">=</span> <span class="mf">0.1</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arch_params</span><span class="p">,</span> <span class="n">chckpt_filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">arch_params</span><span class="p">,</span> <span class="n">chckpt_filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slope_coef</span> <span class="o">=</span> <span class="n">arch_params</span><span class="p">[</span><span class="s2">&quot;slope_coef&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_train_dist</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_train_dist</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_calc_const_coef</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculates the constant coefficient for the lineal transformation,</span>
<span class="sd">        derived from the equation:</span>

<span class="sd">        KPI_DIST_0 = 1/(1 + exp(-(a * dist + b)), when dist = 0</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: Constant coefficient for the lineal transformation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">KPI_DIST_0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_output_kpi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scaled_dist_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Outputs KPI from 0 to 1, where the closer to 1 the more likely the sample</span>
<span class="sd">        is an anomaly, based on a distance metric.</span>

<span class="sd">        Args:</span>
<span class="sd">            scaled_dist_data (np.ndarray): Distance metric data</span>
<span class="sd">            slope_coef (float): Slope coefficient for the lineal transformation</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: KPI results</span>

<span class="sd">        Note: The constant coefficient is calculated based on the max train distance being 0,</span>
<span class="sd">            so distance_data should be normalized using scale_distance()</span>
<span class="sd">            before calling this function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sigmoid</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">))</span>
        <span class="n">kpi</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slope_coef</span> <span class="o">*</span> <span class="n">scaled_dist_data</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_const_coef</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">kpi</span>

    <span class="k">def</span> <span class="nf">_set_save_min_max_train_dist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_train_dist</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">max_train_dist</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">out_chckpt_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the attributes minimum and maximum distance metric values for training data,</span>
<span class="sd">        also saves them on a file by calling self.save_scale_params.</span>

<span class="sd">        Args:</span>
<span class="sd">            min_train_dist (float): Minimum distance metric value for training data</span>
<span class="sd">            max_train_dist (float): Maximum distance metric value for training data</span>
<span class="sd">            out_chckpt_filepath (str): Path to the checkpoint file where the model will be saved</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_train_dist</span> <span class="o">=</span> <span class="n">min_train_dist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_train_dist</span> <span class="o">=</span> <span class="n">max_train_dist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_scale_params</span><span class="p">(</span><span class="n">out_chckpt_filepath</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_scale_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scales the distance metric using previously learned scale params,</span>
<span class="sd">        where -1 is the min train distance and 0 is the max train distance.</span>

<span class="sd">        Args:</span>
<span class="sd">            dist (np.ndarray): Distance metric data</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: Scaled distance metric data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_train_dist</span>
        <span class="n">t_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_train_dist</span>
        <span class="k">return</span> <span class="p">((</span><span class="n">dist</span> <span class="o">-</span> <span class="n">t_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">t_max</span> <span class="o">-</span> <span class="n">t_min</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_save_scale_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_chckpt_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Saves the attributes min_train_dist and max_train_dist on a file.</span>
<span class="sd">        Uses the models save path (out_chckpt_filepath) to derive another to save the scaling.</span>

<span class="sd">        Args:</span>
<span class="sd">            out_chckpt_filepath (str): Path to the checkpoint file where the model will be saved</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">orig_filepath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">out_chckpt_filepath</span><span class="p">)</span>
        <span class="n">scale_filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">orig_filepath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_scale_params.pkl&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">scale_filepath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;min_train_dist&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_train_dist</span><span class="p">,</span>
                    <span class="s2">&quot;max_train_dist&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_train_dist</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">f</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_scale_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chckpt_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loads the attributes min_train_dist and max_train_dist from a file.</span>
<span class="sd">        Uses the models load path (chckpt_filepath) to derive another to load the scaling.</span>

<span class="sd">        Args:</span>
<span class="sd">            chckpt_filepath (str): Path to the checkpoint file where the model will be loaded</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">orig_filepath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">chckpt_filepath</span><span class="p">)</span>
        <span class="n">scale_filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">orig_filepath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_scale_params.pkl&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">scale_filepath</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">scale_params</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">min_train_dist</span> <span class="o">=</span> <span class="n">scale_params</span><span class="p">[</span><span class="s2">&quot;min_train_dist&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_train_dist</span> <span class="o">=</span> <span class="n">scale_params</span><span class="p">[</span><span class="s2">&quot;max_train_dist&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_plot_kpi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">log_filepath</span><span class="p">):</span>
        <span class="n">y_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;kpi&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">})</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">y_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;kpi&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">write_html</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">log_filepath</span><span class="si">}</span><span class="s2">.kpi.html&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pred_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="s2">&quot;MEAN&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;aggregated KPI: </span><span class="si">{</span><span class="n">pred_mean</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AutoEncoderModel"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.AutoEncoderModel">[docs]</a><span class="k">class</span> <span class="nc">AutoEncoderModel</span><span class="p">(</span><span class="n">BaseAnomalyModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for all AutoEncoder Deep Learning architectures.</span>
<span class="sd">    Inherits from BaseAnomalyModel. Classes that inherit from this class are:</span>
<span class="sd">        - AutoMLP</span>
<span class="sd">        - AutoCNN</span>
<span class="sd">        - AutoRNN</span>

<span class="sd">    Defines the methods that are common to all AutoEncoder DL architectures, which are:</span>
<span class="sd">        - mean_squared_error (static method)</span>
<span class="sd">        - fit</span>
<span class="sd">        - predict</span>

<span class="sd">    Introduces the following necessary values in arch_params:</span>
<span class="sd">        - arch_params[&quot;contamination&quot;] (float): Proportion of outliers in the data set</span>

<span class="sd">    Introduces the following necessary values in train_params:</span>
<span class="sd">        - train_params[&quot;epochs&quot;] (int): Number of epochs to train the model</span>
<span class="sd">        - train_params[&quot;batch_size&quot;] (int): Batch size for training the model</span>

<span class="sd">    Introduces the following instance attributes to be filled by the child classes:</span>
<span class="sd">        - self.use_split_windows (bool): Whether to use the method split windows or not,</span>
<span class="sd">            used to split the data set into an array of windows (matrices) before entering</span>
<span class="sd">            the model; used by the child classes AutoCNN and AutoRNN</span>
<span class="sd">        - self.windows_size (int): Size of the windows to be split into</span>
<span class="sd">            (only used if use_split_windows is True)</span>
<span class="sd">        - self.overlap (int): Overlap size to use when splitting the data set into windows</span>
<span class="sd">            (only used if use_split_windows is True)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arch_params</span><span class="p">,</span> <span class="n">chckpt_filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">arch_params</span><span class="p">,</span> <span class="n">chckpt_filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contamination</span> <span class="o">=</span> <span class="n">arch_params</span><span class="p">[</span><span class="s2">&quot;contamination&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_split_windows</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;scores&quot;</span> <span class="ow">in</span> <span class="n">arch_params</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="n">arch_params</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;kpi&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="AutoEncoderModel.mean_squared_error"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.AutoEncoderModel.mean_squared_error">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">mean_squared_error</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutoEncoderModel.fit"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.AutoEncoderModel.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">y_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
        <span class="n">X_valid</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">y_valid</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
        <span class="n">train_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">out_chckpt_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">log_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">metrics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit method for AutoEncoder models.</span>
<span class="sd">        Fits the internal model with the given data, by using the same input as the output; and</span>
<span class="sd">        saves the model on the defined checkpoint file.</span>

<span class="sd">        train_params must contain the following values:</span>
<span class="sd">            - train_params[&quot;epochs&quot;] (int): Number of epochs to train the model</span>
<span class="sd">            - train_params[&quot;batch_size&quot;] (int): Batch size for training the model</span>

<span class="sd">        Args:</span>
<span class="sd">            X_train (pd.DataFrame): Input data</span>
<span class="sd">            y_train (pd.Series): Ignored for autoencoders, as the model is trained with the same input</span>
<span class="sd">            X_valid (pd.DataFrame): Ignored for unsupervised models</span>
<span class="sd">            y_valid (pd.Series): Ignored for unsupervised models</span>
<span class="sd">            train_params (Dict[str, Any]): Dictionary with parameters necessary for training</span>
<span class="sd">            out_chckpt_filepath (str): Path to the checkpoint file where the model will be saved</span>
<span class="sd">            log_filepath (str): Path to the log file used to log training progress</span>
<span class="sd">            metrics (List[str]): List of metrics to be used for training</span>

<span class="sd">        *Note: Right now the metrics are not used for training.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">epochs</span> <span class="o">=</span> <span class="n">train_params</span><span class="p">[</span><span class="s2">&quot;epochs&quot;</span><span class="p">]</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">train_params</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span>

        <span class="c1"># split the data into windows</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_split_windows</span><span class="p">:</span>
            <span class="n">X_train_array</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_windows</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span>
            <span class="n">X_valid_array</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">,</span> <span class="n">X_valid_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_windows</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X_train_array</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">values</span>
            <span class="n">X_valid_array</span> <span class="o">=</span> <span class="n">X_valid</span><span class="o">.</span><span class="n">values</span>
            <span class="n">X_valid_index</span> <span class="o">=</span> <span class="n">X_valid</span><span class="o">.</span><span class="n">index</span>


        <span class="c1"># output (y) is the same x input</span>
        <span class="n">y_train_array</span> <span class="o">=</span> <span class="n">X_train_array</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">X_train_array</span><span class="p">,</span>
            <span class="n">y_train_array</span><span class="p">,</span>
            <span class="n">epochs</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="p">,</span>
            <span class="n">out_chckpt_filepath</span><span class="p">,</span>
            <span class="n">log_filepath</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># calculate min and max train distance</span>
        <span class="n">X_train_recons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train_array</span><span class="p">)</span>  <span class="c1"># reconstructed x</span>
        <span class="n">train_dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">(</span>
            <span class="n">X_train_array</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X_train_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">X_train_recons</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X_train_recons</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">min_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">train_dist</span><span class="p">)</span>
        <span class="n">max_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">train_dist</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">contamination</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_save_min_max_train_dist</span><span class="p">(</span><span class="n">min_dist</span><span class="p">,</span> <span class="n">max_dist</span><span class="p">,</span> <span class="n">out_chckpt_filepath</span><span class="p">)</span>

        <span class="c1"># Validate the model</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Predicting on validation split...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">X_valid_recons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid_array</span><span class="p">)</span>  <span class="c1"># reconstructed x_valid</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_kpi</span><span class="p">(</span><span class="n">X_valid_array</span><span class="p">,</span> <span class="n">X_valid_recons</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;kpi&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_kpi</span><span class="p">(</span><span class="n">X_valid_index</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">log_filepath</span><span class="p">)</span></div>

<div class="viewcode-block" id="AutoEncoderModel.predict_kpi"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.AutoEncoderModel.predict_kpi">[docs]</a>    <span class="k">def</span> <span class="nf">predict_kpi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x_hat</span><span class="p">):</span>
        <span class="c1"># calculate error with MSE</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_squared_error</span><span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">x_hat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_hat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># scale and output KPI</span>
        <span class="n">scaled_dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_distance</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_kpi</span><span class="p">(</span><span class="n">scaled_dist</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">predictions</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span></div>

<div class="viewcode-block" id="AutoEncoderModel.predict"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.AutoEncoderModel.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">timestamps</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
        <span class="n">aggregation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">log_filepath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Predict method for AutoEncoder models.</span>
<span class="sd">        Uses the internal model reconstruct the input data, calculate the error between the</span>
<span class="sd">        original and the reconstructed data, and returns a KPI between 0 and 1 using this error.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (pd.DataFrame): Input data</span>
<span class="sd">            timestamps (pd.Series): Timestamps for the input data. Deprecated, not used</span>
<span class="sd">            aggregation (str): Aggregation method to be used for prediction</span>
<span class="sd">            log_filepath (str): Path to the log file used to log training progress</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[np.ndarray, np.ndarray]: Tuple with predicted KPI values and aggregated values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># split the data into windows</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_split_windows</span><span class="p">:</span>
            <span class="n">x_array</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">x_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_windows</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">x_index</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span>
            <span class="n">x_array</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># make predictions with the model</span>
        <span class="n">recons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_array</span><span class="p">,</span> <span class="n">log_filepath</span><span class="p">)</span>  <span class="c1"># reconstructed x</span>

        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_kpi</span><span class="p">(</span><span class="n">x_array</span><span class="p">,</span> <span class="n">recons</span><span class="p">)</span>
        <span class="n">aggregated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">aggregation</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">log_filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;all predictions:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">x_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_index</span><span class="p">,</span> <span class="n">predictions</span><span class="p">):</span>
                        <span class="n">t_str</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\t</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;aggregated prediction: </span><span class="si">{</span><span class="n">aggregated</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;kpi&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_kpi</span><span class="p">(</span><span class="n">x_index</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">log_filepath</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">aggregated</span></div>

<div class="viewcode-block" id="AutoEncoderModel.parse_fit_logging"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.AutoEncoderModel.parse_fit_logging">[docs]</a>    <span class="k">def</span> <span class="nf">parse_fit_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_filepath</span><span class="p">):</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s2">&quot;kpi&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">log_filepath</span><span class="si">}</span><span class="s2">.kpi.html&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">scores</span><span class="p">[</span><span class="s2">&quot;kpi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">scores</span></div>

<div class="viewcode-block" id="AutoEncoderModel.parse_predict_logging"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.AutoEncoderModel.parse_predict_logging">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parse_predict_logging</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">):</span>
        <span class="n">timestamps</span><span class="p">,</span> <span class="n">all_kpis</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;\d</span><span class="si">{4}</span><span class="s2">-\d?\d-\d?\d (?:2[0-3]|[01]?[0-9]):[0-5]?[0-9]:[0-5]?[0-9]:</span><span class="se">\t</span><span class="s2">.+&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                    <span class="n">parse</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parse</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">all_kpis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">parse</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="p">)))</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">log_filepath</span><span class="si">}</span><span class="s2">.kpi.html&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">kpi_plot</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">timestamps</span><span class="p">,</span> <span class="n">all_kpis</span><span class="p">,</span> <span class="n">kpi_plot</span></div></div>


<div class="viewcode-block" id="SklearnAnomalyModel"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.SklearnAnomalyModel">[docs]</a><span class="k">class</span> <span class="nc">SklearnAnomalyModel</span><span class="p">(</span><span class="n">BaseAnomalyModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for all Sklearn Anomaly (or Novelty) detection models.</span>
<span class="sd">    Inherits from BaseAnomalyModel. Classes that inherit from this class are:</span>
<span class="sd">        - IsolationForestAnomalyModel</span>
<span class="sd">        - EllipticEnvelopeAnomalyModel</span>
<span class="sd">        - LocalOutlierFactorAnomalyModel</span>
<span class="sd">        - OneClassSVMAnomalyModel</span>

<span class="sd">    Defines the methods that are common to all Sklearn Anomaly ML architectures, which are:</span>
<span class="sd">        - load_model</span>
<span class="sd">        - save_model</span>
<span class="sd">        - fit</span>
<span class="sd">        - predict</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arch_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chckpt_filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SklearnAnomalyModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">arch_params</span><span class="p">,</span> <span class="n">chckpt_filepath</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;scores&quot;</span> <span class="ow">in</span> <span class="n">arch_params</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="n">arch_params</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;kpi&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="SklearnAnomalyModel.load_model"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.SklearnAnomalyModel.load_model">[docs]</a>    <span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loads the sklearn model from the checkpoint file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chckpt_filepath</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arch_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_params</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_scale_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chckpt_filepath</span><span class="p">)</span></div>

<div class="viewcode-block" id="SklearnAnomalyModel.save_model"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.SklearnAnomalyModel.save_model">[docs]</a>    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_chckpt_filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Saves the sklearn model on the defined checkpoint file.</span>

<span class="sd">        Args:</span>
<span class="sd">            out_chckpt_filepath (str): Path to the checkpoint file where the model will be saved</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_chckpt_filepath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>

<div class="viewcode-block" id="SklearnAnomalyModel.fit"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.SklearnAnomalyModel.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">y_train</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
        <span class="n">X_valid</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">y_valid</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
        <span class="n">train_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">out_chckpt_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">log_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">metrics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit method for Sklearn Anomaly models.</span>
<span class="sd">        Fits the internal model with the given data, and saves the model on the defined file.</span>

<span class="sd">        Args:</span>
<span class="sd">            X_train (pd.DataFrame): Input data</span>
<span class="sd">            y_train (pd.Series): Ignored for sklearn anomaly models.</span>
<span class="sd">            X_valid (pd.DataFrame): Ignored for unsupervised models.</span>
<span class="sd">            y_valid (pd.Series): Ignored for unsupervised models.</span>
<span class="sd">            train_params (Dict[str, Any]): Ignored for Sklearn Anomaly models.</span>
<span class="sd">            out_chckpt_filepath (str): Path to the checkpoint file where the model will be saved</span>
<span class="sd">            log_filepath (str): Path to the log file used to log training progress</span>
<span class="sd">            metrics (List[str]): List of metrics to be used for training</span>

<span class="sd">        *Note: Right now the metrics and log_filepath are not used for training.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Train the model</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Training the Sklearn model on train split...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>

        <span class="c1"># Save the model</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Saving the Sklearn&#39;s model...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">out_chckpt_filepath</span><span class="p">)</span>
        <span class="n">train_dist</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>  <span class="c1"># calculate min train distance (max is 0)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_save_min_max_train_dist</span><span class="p">(</span><span class="n">train_dist</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">out_chckpt_filepath</span><span class="p">)</span>

        <span class="c1"># Validate the model</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Predicting on validation split...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_kpi</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;kpi&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_kpi</span><span class="p">(</span><span class="n">X_valid</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">log_filepath</span><span class="p">)</span></div>

<div class="viewcode-block" id="SklearnAnomalyModel.plot_validation"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.SklearnAnomalyModel.plot_validation">[docs]</a>    <span class="k">def</span> <span class="nf">plot_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arch_name</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit method for Sklearn Anomaly models.</span>
<span class="sd">        Fits the internal model with the given data, and saves the model on the defined file.</span>

<span class="sd">        Args:</span>
<span class="sd">            X_train (pd.DataFrame): Input data</span>
<span class="sd">            y_train (pd.Series): Ignored for sklearn anomaly models.</span>
<span class="sd">            X_valid (pd.DataFrame): Ignored for unsupervised models.</span>
<span class="sd">            y_valid (pd.Series): Ignored for unsupervised models.</span>
<span class="sd">            train_params (Dict[str, Any]): Ignored for Sklearn Anomaly models.</span>
<span class="sd">            out_chckpt_filepath (str): Path to the checkpoint file where the model will be saved</span>
<span class="sd">            log_filepath (str): Path to the log file used to log training progress</span>
<span class="sd">            metrics (List[str]): List of metrics to be used for training</span>

<span class="sd">        *Note: Right now the metrics and log_filepath are not used for training.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If the arch_name is:</span>
        <span class="c1"># - IsolationForestAnomalyModel</span>
        <span class="c1"># - EllipticEnvelopeAnomalyModel</span>
        <span class="c1"># - LocalOutlierFactorAnomalyModel</span>
        <span class="c1"># - OneClassSVMAnomalyModel</span>
        <span class="c1"># plot the validation results</span>
        <span class="n">arch_name</span> <span class="o">=</span> <span class="n">arch_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">arch_name</span> <span class="o">==</span> <span class="s2">&quot;isolation forest&quot;</span>
            <span class="ow">or</span> <span class="n">arch_name</span> <span class="o">==</span> <span class="s2">&quot;elliptic envelope&quot;</span>
            <span class="ow">or</span> <span class="n">arch_name</span> <span class="o">==</span> <span class="s2">&quot;local outlier factor&quot;</span>
            <span class="ow">or</span> <span class="n">arch_name</span> <span class="o">==</span> <span class="s2">&quot;one-class svm&quot;</span>
        <span class="p">):</span>
            <span class="c1"># train the model</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">X_valid</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># scale and output KPI</span>
            <span class="n">scaled_dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_distance</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_kpi</span><span class="p">(</span><span class="n">scaled_dist</span><span class="p">)</span>
            <span class="n">timestamp_pred</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">[</span><span class="n">X_valid</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">timestamp_pred</span><span class="p">,</span> <span class="s2">&quot;pred&quot;</span><span class="p">:</span> <span class="n">predictions</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]}</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;pred&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="s2">&quot;fig1.webp&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="SklearnAnomalyModel.predict_kpi"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.SklearnAnomalyModel.predict_kpi">[docs]</a>    <span class="k">def</span> <span class="nf">predict_kpi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># make probability predictions with the model</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># scale and output KPI</span>
        <span class="n">scaled_dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_distance</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_kpi</span><span class="p">(</span><span class="n">scaled_dist</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">predictions</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span></div>

<div class="viewcode-block" id="SklearnAnomalyModel.predict"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.SklearnAnomalyModel.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">timestamps</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
        <span class="n">aggregation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">log_filepath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Predict method for Sklearn Anomaly models.</span>
<span class="sd">        Uses the internal model&#39;s decision_function to get a distance metric score for</span>
<span class="sd">        the input data, and returns a calculated KPI between 0 and 1 using this score.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (pd.DataFrame): Input data</span>
<span class="sd">            timestamps (pd.Series): Timestamps for the input data. Deprecated, not used</span>
<span class="sd">            aggregation (str): Aggregation method to be used for prediction</span>
<span class="sd">            log_filepath (str): Path to the log file used to log training progress</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[np.ndarray, np.ndarray]: Tuple with predicted KPI values and aggregated values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># make probability predictions with the model</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_kpi</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">aggregated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">aggregation</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">log_filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_index</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;all predictions:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">x_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_index</span><span class="p">,</span> <span class="n">predictions</span><span class="p">):</span>
                        <span class="n">t_str</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t_str</span><span class="si">}</span><span class="s2">:</span><span class="se">\t</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;aggregated prediction: </span><span class="si">{</span><span class="n">aggregated</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;kpi&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_kpi</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">log_filepath</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">aggregated</span></div>

<div class="viewcode-block" id="SklearnAnomalyModel.parse_fit_logging"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.SklearnAnomalyModel.parse_fit_logging">[docs]</a>    <span class="k">def</span> <span class="nf">parse_fit_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_filepath</span><span class="p">):</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s2">&quot;kpi&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">log_filepath</span><span class="si">}</span><span class="s2">.kpi.html&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">scores</span><span class="p">[</span><span class="s2">&quot;kpi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">scores</span></div>

<div class="viewcode-block" id="SklearnAnomalyModel.parse_predict_logging"><a class="viewcode-back" href="../../../moncon.ml.html#moncon.ml.base_arch.SklearnAnomalyModel.parse_predict_logging">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parse_predict_logging</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">):</span>
        <span class="n">timestamps</span><span class="p">,</span> <span class="n">all_kpis</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;\d</span><span class="si">{4}</span><span class="s2">-\d?\d-\d?\d (?:2[0-3]|[01]?[0-9]):[0-5]?[0-9]:[0-5]?[0-9]:</span><span class="se">\t</span><span class="s2">.+&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                    <span class="n">parse</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parse</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">all_kpis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">parse</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="p">)))</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">log_filepath</span><span class="si">}</span><span class="s2">.kpi.html&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">kpi_plot</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">timestamps</span><span class="p">,</span> <span class="n">all_kpis</span><span class="p">,</span> <span class="n">kpi_plot</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, PredictiveLab Contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>